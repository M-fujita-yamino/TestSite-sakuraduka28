<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Ê°úÂ°ö28ÊúüÔºöÂêçÁ∞ø„Éû„Çπ„Çø„ÉºÁÆ°ÁêÜ V4.1</title>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Zen Maru Gothic', sans-serif; margin: 0; background-color: #ffeef5; color: #555; font-size: 13px; overflow: hidden; }
        
        .header-panel { 
            background: rgba(255, 255, 255, 0.98); padding: 10px 15px; 
            box-shadow: 0 2px 10px rgba(233, 30, 99, 0.1); position: relative; z-index: 200;
            border-bottom: 1px solid #ffc0cb; display: flex; flex-wrap: wrap; align-items: center; gap: 10px;
        }
        h2 { margin: 0; font-size: 16px; color: #d81b60; white-space: nowrap; }
        .status-badge { font-size: 10px; padding: 2px 8px; border-radius: 10px; font-weight: bold; border: 1px solid #2ecc71; color: #2ecc71; background: #fff; border: 1px solid; }

        .controls { display: flex; gap: 6px; align-items: center; margin-left: auto; }
        .search-input { padding: 6px 12px; border: 1px solid #ffc0cb; border-radius: 15px; font-size: 12px; width: 140px; outline: none; }
        .filter-sel { padding: 5px; border: 1px solid #ffc0cb; border-radius: 10px; font-size: 11px; background: white; color: #d81b60; outline: none; }
        .btn-add { background: #d81b60; color: white; border: none; padding: 7px 15px; border-radius: 15px; cursor: pointer; font-size: 11px; font-weight: bold; }

        .main-content { height: calc(100vh - 65px); overflow-y: auto; display: flex; justify-content: center; }

        table { border-collapse: collapse; background: #fff; table-layout: fixed; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 50px; }
        thead th { 
            background: #a51d4d; color: white; padding: 10px 2px; font-size: 11px; 
            cursor: pointer; position: sticky; top: 0; z-index: 150; border: 1px solid #8e153e;
        }
        td { padding: 8px 4px; border: 1px solid #ffeef5; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-align: center; }

        .w-no { width: 40px; color: #bbb; font-size: 10px; }
        .w-name { width: 110px; font-weight: bold; text-align: left; padding-left: 10px; } 
        .w-kana { width: 130px; color: #888; text-align: left; }
        .w-gen { width: 50px; }
        .w-cls { width: 50px; font-weight: bold; color: #d81b60; }
        .w-act { width: 50px; }

        .editable { background: #fffafc; cursor: text; }
        .editable:focus { background: #fff; outline: 1px solid #ff8da1; }
        .gender-tag { padding: 3px 7px; border-radius: 6px; font-size: 10px; font-weight: bold; cursor: pointer; }
        .gender-Áî∑ { background: #e3f2fd; color: #1e88e5; }
        .gender-Â•≥ { background: #fce4ec; color: #d81b60; }
        .del-link { color: #ccc; font-size: 11px; cursor: pointer; }
        .del-link:hover { color: #ea4335; }
    </style>
</head>
<body>

<div class="header-panel">
    <h2>üå∏ ÂêçÁ∞ø„Éû„Çπ„Çø„Éº V4.1</h2>
    <div id="status" class="status-badge">ÂêåÊúüÊ∏à„Åø</div>
    <div class="controls">
        <input type="text" id="q" class="search-input" placeholder="ÂêçÂâç„Éª„Ç´„ÉäÊ§úÁ¥¢...">
        <select id="fGen" class="filter-sel"><option value="">ÊÄßÂà•</option><option value="Áî∑">Áî∑</option><option value="Â•≥">Â•≥</option></select>
        <select id="fC1" class="filter-sel"><option value="">1Âπ¥</option></select>
        <select id="fC2" class="filter-sel"><option value="">2Âπ¥</option></select>
        <select id="fC3" class="filter-sel"><option value="">3Âπ¥</option></select>
        <button class="btn-add" onclick="addM()">ÔºãÊñ∞Ë¶è</button>
        <div style="font-size:12px; font-weight:bold; color:#d81b60; min-width:35px; text-align:right;">[<span id="cnt">0</span>]</div>
    </div>
</div>

<div class="main-content">
    <table id="tbl">
        <thead>
            <tr>
                <th class="w-no">No</th>
                <th class="w-name" onclick="srt('name')">Ê∞èÂêç ‚ñº‚ñ≤</th>
                <th class="w-kana" onclick="srt('kana')">„Ç´„Éä ‚ñº‚ñ≤</th>
                <th class="w-gen" onclick="srt('gen')">ÊÄßÂà•</th>
                <th class="w-cls" onclick="srt('c1')">1Âπ¥</th>
                <th class="w-cls" onclick="srt('c2')">2Âπ¥</th>
                <th class="w-cls" onclick="srt('c3')">3Âπ¥</th>
                <th class="w-act">Êìç‰Ωú</th>
            </tr>
        </thead>
        <tbody id="out"></tbody>
    </table>
</div>

<script>
    const MEIBO_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTzLqpB8e6tiN06L-urFd1agctJ6JIlfJQW-JcybZ_VrVYOh7D9uwk6PlIlO8wCpcQKVyUKRJOnchn-/pub?gid=0&single=true&output=csv";
    const PHOTO_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQxm8bS1RxZlhBjac5oQrMUVpurJbcYUKCPyMAl5Ut26gJ4U-g6pbvdlJryP1c2rUJsWt0eJm-H0Nee/pub?gid=0&single=true&output=csv";
    const GAS = "https://script.google.com/macros/s/AKfycbyj-nWSJYOn2_ry9z7UNv9LBxeUyAQkO4ixdwNht6KaVX6UFW6EnXvPq733-jDw2vvz4w/exec";

    let data = [];
    let photoMap = {}; 
    let sK = 'kana'; 
    let sA = true;

    // --- Âº∑Âåñ„Åï„Çå„Åü getG Èñ¢Êï∞ ---
    function getG(v) {
        if(!v) return "";
        let s = String(v).trim();
        // 1. ÊñáÊú´„ÅÆÊï∞Â≠ó„ÇíÊúÄÂÑ™ÂÖàÔºà‰æãÔºö„Äå3-5„Äç„Äå3Âπ¥5ÁµÑ„Äç„Äå3Êúà5Êó•„Äç‚Üí 5Ôºâ
        let m = s.match(/(\d+)$/);
        // 2. „Éè„Ç§„Éï„É≥„ÅÆÂæå„Çç„ÅÆÊï∞Â≠óÔºà‰æãÔºö„Äå3-5„Äç‚Üí 5Ôºâ
        if(!m) m = s.match(/-(\d+)/);
        // 3. „Åù„Çå„Åß„ÇÇ„ÉÄ„É°„Å™„ÇâÊúÄÂàù„Å´Ë¶ã„Å§„Åã„Å£„ÅüÊï∞Â≠ó
        if(!m) m = s.match(/(\d+)/);
        
        return m ? m[1] : s;
    }

    async function load() {
        try {
            const resP = await fetch(PHOTO_CSV);
            const txtP = await resP.text();
            txtP.split('\n').slice(1).forEach(line => {
                const cols = line.split(',');
                if(cols.length >= 2) photoMap[cols[0].trim()] = cols[1].trim();
            });

            const resM = await fetch(MEIBO_CSV);
            const txtM = await resM.text();
            const rows = txtM.replace(/\r/g, '').split('\n').slice(1);
            data = rows.map(r => {
                const c = r.split(',');
                return { 
                    originalName: (c[0]||"").trim(), 
                    name: (c[0]||"").trim(), 
                    kana: (c[1]||"").trim(), 
                    c1: getG(c[2]), 
                    c2: getG(c[4]), 
                    c3: getG(c[6]), 
                    gen: (c[8]||"Áî∑").trim() 
                };
            }).filter(m => m.name);

            updateFilters();
            render();
        } catch (e) { console.error("Data Load Error"); }
    }

    function updateFilters() {
        const setOpts = (id, key) => {
            const sel = document.getElementById(id);
            const cur = sel.value;
            // Êï∞ÂÄ§„Å®„Åó„Å¶„ÇΩ„Éº„Éà
            const vals = [...new Set(data.map(m => m[key]))]
                        .filter(v => v && !isNaN(v))
                        .sort((a,b) => parseInt(a) - parseInt(b));
            
            sel.innerHTML = `<option value="">${sel.options[0].text}</option>`;
            vals.forEach(v => {
                sel.innerHTML += `<option value="${v}" ${v==cur?'selected':''}>${v}ÁµÑ</option>`;
            });
        };
        setOpts('fC1', 'c1'); setOpts('fC2', 'c2'); setOpts('fC3', 'c3');
    }

    function render() {
        const body = document.getElementById('out');
        const query = document.getElementById('q').value.toLowerCase();
        const f_gen = document.getElementById('fGen').value;
        const f_c1 = document.getElementById('fC1').value;
        const f_c2 = document.getElementById('fC2').value;
        const f_c3 = document.getElementById('fC3').value;

        body.innerHTML = "";
        const filtered = data.filter(m => {
            return (m.name.includes(query) || m.kana.includes(query)) &&
                   (!f_gen || m.gen === f_gen) &&
                   (!f_c1 || m.c1 === f_c1) &&
                   (!f_c2 || m.c2 === f_c2) &&
                   (!f_c3 || m.c3 === f_c3);
        });

        filtered.forEach((m, i) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="w-no">${i+1}</td>
                <td class="w-name editable" contenteditable="true" onblur="sync('${m.originalName}','ÂêçÂâç',this.innerText)">${m.name}</td>
                <td class="w-kana editable" contenteditable="true" onblur="sync('${m.originalName}','„Éï„É™„Ç¨„Éä',this.innerText)">${m.kana}</td>
                <td class="w-gen"><span class="gender-tag gender-${m.gen}" onclick="tglG(this,'${m.originalName}')">${m.gen}</span></td>
                <td class="w-cls editable" contenteditable="true" onblur="sync('${m.originalName}','1Âπ¥ÁµÑ',this.innerText)">${m.c1}</td>
                <td class="w-cls editable" contenteditable="true" onblur="sync('${m.originalName}','2Âπ¥ÁµÑ',this.innerText)">${m.c2}</td>
                <td class="w-cls editable" contenteditable="true" onblur="sync('${m.originalName}','3Âπ¥ÁµÑ',this.innerText)">${m.c3}</td>
                <td class="w-act"><span class="del-link" onclick="delM('${m.originalName}')">ÂâäÈô§</span></td>
            `;
            body.appendChild(tr);
        });
        document.getElementById('cnt').innerText = filtered.length;
    }

    async function sync(oldName, col, newVal) {
        const st = document.getElementById('status');
        st.innerText = "ÂêåÊúü‰∏≠..."; st.style.borderColor="#f1c40f"; st.style.color="#f1c40f";
        
        let val = String(newVal).trim();
        let sendVal = val;
        if(col.includes('ÁµÑ') && val && !val.includes('-')) {
            sendVal = col.charAt(0) + "-" + val;
        }

        try {
            const res = await fetch(GAS, { method: "POST", body: JSON.stringify({ name: oldName, column: col, value: sendVal }) });
            if(!res.ok) throw new Error();
            st.innerText = "ÂêåÊúüÊ∏à„Åø"; st.style.borderColor="#2ecc71"; st.style.color="#2ecc71";
            
            const target = data.find(m => m.originalName === oldName);
            if(target) {
                if(col === 'ÂêçÂâç') target.originalName = val;
                const keyMap = {"ÂêçÂâç":"name", "„Éï„É™„Ç¨„Éä":"kana", "1Âπ¥ÁµÑ":"c1", "2Âπ¥ÁµÑ":"c2", "3Âπ¥ÁµÑ":"c3", "ÊÄßÂà•":"gen"};
                if(keyMap[col]) target[keyMap[col]] = (col.includes('ÁµÑ')) ? getG(val) : val;
                if(col.includes('ÁµÑ')) updateFilters();
            }
        } catch (e) { 
            st.innerText = "ÂêåÊúüÂ§±Êïó"; st.style.borderColor="#ea4335"; st.style.color="#ea4335";
        }
    }

    function tglG(el, name) {
        const nxt = el.innerText.trim() === 'Áî∑' ? 'Â•≥' : 'Áî∑';
        el.innerText = nxt; el.className = `gender-tag gender-${nxt}`;
        sync(name, 'ÊÄßÂà•', nxt);
    }

    function addM() {
        const n = prompt("Êñ∞Ë¶èËøΩÂä†„Åô„ÇãÊ∞èÂêç„ÇíÂÖ•Âäõ");
        if(n) { data.unshift({originalName:n, name:n, kana:"", c1:"", c2:"", c3:"", gen:"Áî∑"}); render(); sync(n, "ÂêçÂâç", n); }
    }

    async function delM(name) {
        if(confirm(name + " „Åï„Çì„ÅÆ„Éá„Éº„Çø„ÇíÂÆåÂÖ®„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) {
            await fetch(GAS, { method: "POST", body: JSON.stringify({ action: "delete", name: name }) });
            data = data.filter(m => m.originalName !== name); render();
        }
    }

    function srt(k) {
        sA = (sK === k) ? !sA : true; sK = k;
        data.sort((a, b) => {
            let va = a[k], vb = b[k];
            if(k.includes('c')) { va = parseInt(va)||0; vb = parseInt(vb)||0; }
            return (va < vb ? -1 : 1) * (sA ? 1 : -1);
        });
        render();
    }

    ['q', 'fGen', 'fC1', 'fC2', 'fC3'].forEach(id => {
        document.getElementById(id).addEventListener(id==='q'?'input':'change', render);
    });

    load();
</script>
</body>
</html>
