<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>åç°¿ç®¡ç†ï¼šé€æ¬¡åŒæœŸã‚¨ãƒ‡ã‚£ã‚¿ï¼ˆã‚¯ãƒ©ã‚¹é›†ä¸­ç‰ˆï¼‰</title>
    <style>
        body { font-family: sans-serif; margin: 0; background: #f0f2f5; color: #333; padding: 10px; }
        .header { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        .status-bar { font-size: 11px; padding: 3px 10px; border-radius: 4px; display: inline-block; margin-left: 10px; vertical-align: middle; }
        .sync-ok { background: #e6ffed; color: #22863a; border: 1px solid #22863a; }
        .sync-loading { background: #fff8c5; color: #735c0f; border: 1px solid #735c0f; }
        .btn { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: bold; font-size: 13px; }
        .btn-add { background: #1a73e8; }
        
        .controls { display: flex; gap: 8px; margin-top: 10px; align-items: center; }
        input[type="text"] { padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; }
        
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 10px; table-layout: fixed; }
        th { background: #f8f9fa; padding: 8px; text-align: left; border: 1px solid #dee2e6; cursor: pointer; font-size: 12px; position: sticky; top: 105px; }
        th:hover { background: #eee; }
        td { padding: 8px; border: 1px solid #eee; font-size: 13px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        /* åˆ—å¹…ã®æœ€é©åŒ–ï¼ˆURLã‚’æ¶ˆã—ãŸåˆ†ã€å„é …ç›®ã‚’åºƒãï¼‰ */
        .col-no { width: 40px; text-align: center; color: #999; }
        .col-name { width: 120px; font-weight: bold; }
        .col-kana { width: 150px; }
        .col-gen { width: 60px; text-align: center; }
        .col-class { width: 80px; text-align: center; }
        .col-act { width: 60px; text-align: center; }

        .editable { background: #fffde7; cursor: text; transition: 0.2s; }
        .editable:focus { background: #fff; outline: 2px solid #1a73e8; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); }
        .gender-tag { padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; cursor: pointer; user-select: none; }
        .gender-ç”· { background: #e3f2fd; color: #1e88e5; }
        .gender-å¥³ { background: #fce4ec; color: #d81b60; }
        .del-link { color: #ea4335; text-decoration: none; font-size: 12px; cursor: pointer; }
        .del-link:hover { text-decoration: underline; }
    </style>
</head>
<body>

<div class="header">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 style="margin:0; font-size:18px; color:#1a73e8;">ğŸ“ åç°¿ãƒ»é€æ¬¡åŒæœŸã‚¨ãƒ‡ã‚£ã‚¿</h2>
        <div id="status" class="status-bar sync-ok">åŒæœŸæ¸ˆã¿</div>
    </div>
    <div class="controls">
        <button class="btn btn-add" onclick="addMember()">ï¼‹ æ–°è¦è¿½åŠ </button>
        <input type="text" id="searchInput" placeholder="æ°åãƒ»ãƒ•ãƒªã‚¬ãƒŠã§æ¤œç´¢..." style="width:200px;">
        <span style="font-size:11px; color:#888;">â€»æ›¸ãæ›ãˆã¦æ å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã§å³æ™‚ä¿å­˜</span>
        <div style="margin-left:auto; font-size:13px; font-weight:bold;">è¨ˆ <span id="count">0</span> å</div>
    </div>
</div>

<table id="mainTable">
    <thead>
        <tr>
            <th class="col-no">No</th>
            <th class="col-name" onclick="sortData('name')">æ°å â–²â–¼</th>
            <th class="col-kana" onclick="sortData('kana')">ãƒ•ãƒªã‚¬ãƒŠ â–²â–¼</th>
            <th class="col-gen" onclick="sortData('gen')">æ€§åˆ¥ â–²â–¼</th>
            <th class="col-class" onclick="sortData('c1')">1å¹´çµ„ â–²â–¼</th>
            <th class="col-class" onclick="sortData('c2')">2å¹´çµ„ â–²â–¼</th>
            <th class="col-class" onclick="sortData('c3')">3å¹´çµ„ â–²â–¼</th>
            <th class="col-act">æ“ä½œ</th>
        </tr>
    </thead>
    <tbody id="tableBody"></tbody>
</table>

<script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTzLqpB8e6tiN06L-urFd1agctJ6JIlfJQW-JcybZ_VrVYOh7D9uwk6PlIlO8wCpcQKVyUKRJOnchn-/pub?gid=0&single=true&output=csv";
    
    // ğŸŒ¸ ã‚¹ãƒ†ãƒƒãƒ—1ã§å–å¾—ã—ãŸã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURLã«æ›¸ãæ›ãˆã¦ãã ã•ã„
    const GAS_URL = "ã“ã“ã«GASã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURLã‚’è²¼ã‚Šä»˜ã‘ã‚‹";

    let memberData = [];
    let sortKey = 'kana';
    let sortAsc = true;

    async function load() {
        try {
            const res = await fetch(CSV_URL);
            const txt = await res.text();
            const rows = txt.replace(/\r/g, '').split('\n').slice(1);
            memberData = rows.map(r => {
                const c = r.split(',');
                return { 
                    name: (c[0]||"").trim(), 
                    kana: (c[1]||"").trim(), 
                    c1: (c[2]||"").trim(), 
                    c2: (c[4]||"").trim(), 
                    c3: (c[6]||"").trim(), 
                    gen: (c[8]||"ç”·").trim() 
                };
            }).filter(m => m.name);
            render();
        } catch (e) { alert("èª­è¾¼å¤±æ•—"); }
    }

    function render() {
        const body = document.getElementById('tableBody');
        const q = document.getElementById('searchInput').value.toLowerCase();
        body.innerHTML = "";

        const filtered = memberData.filter(m => m.name.includes(q) || m.kana.includes(q));

        filtered.forEach((m, i) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="col-no">${i+1}</td>
                <td class="col-name">${m.name}</td>
                <td class="col-kana editable" contenteditable="true" onblur="sync('${m.name}','ãƒ•ãƒªã‚¬ãƒŠ',this.innerText)">${m.kana}</td>
                <td class="col-gen"><span class="gender-tag gender-${m.gen}" onclick="toggleG(this,'${m.name}')">${m.gen}</span></td>
                <td class="col-class editable" contenteditable="true" onblur="sync('${m.name}','1å¹´çµ„',this.innerText)">${m.c1}</td>
                <td class="col-class editable" contenteditable="true" onblur="sync('${m.name}','2å¹´çµ„',this.innerText)">${m.c2}</td>
                <td class="col-class editable" contenteditable="true" onblur="sync('${m.name}','3å¹´çµ„',this.innerText)">${m.c3}</td>
                <td class="col-act"><span class="del-link" onclick="deleteMember('${m.name}')">å‰Šé™¤</span></td>
            `;
            body.appendChild(tr);
        });
        document.getElementById('count').innerText = filtered.length;
    }

    async function sync(name, col, val) {
        const st = document.getElementById('status');
        st.innerText = "åŒæœŸä¸­...";
        st.className = "status-bar sync-loading";
        try {
            await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ name: name, column: col, value: val }) });
            st.innerText = "åŒæœŸå®Œäº†";
            st.className = "status-bar sync-ok";
        } catch (e) { 
            st.innerText = "åŒæœŸå¤±æ•—"; 
            console.error(e);
        }
    }

    function toggleG(el, name) {
        const next = el.innerText === 'ç”·' ? 'å¥³' : 'ç”·';
        el.innerText = next;
        el.className = `gender-tag gender-${next}`;
        sync(name, 'æ€§åˆ¥', next);
    }

    function addMember() {
        const n = prompt("åå‰ã‚’å…¥åŠ›ï¼ˆä¿å­˜ã®ã‚­ãƒ¼ã«ãªã‚Šã¾ã™ï¼‰");
        if(n) { 
            memberData.unshift({name:n, kana:"", c1:"", c2:"", c3:"", gen:"ç”·"}); 
            render(); 
            sync(n, "åå‰", n); 
        }
    }

    async function deleteMember(name) {
        if(confirm(name + "ã•ã‚“ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ã‚‚å³åº§ã«æ¶ˆå»ã•ã‚Œã¾ã™ã€‚")) {
            await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "delete", name: name }) });
            memberData = memberData.filter(m => m.name !== name);
            render();
        }
    }

    function sortData(key) {
        sortAsc = (sortKey === key) ? !sortAsc : true;
        sortKey = key;
        memberData.sort((a, b) => (a[key] < b[key] ? -1 : 1) * (sortAsc ? 1 : -1));
        render();
    }

    document.getElementById('searchInput').oninput = render;
    load();
</script>
</body>
</html>
