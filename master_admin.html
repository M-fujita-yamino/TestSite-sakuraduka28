<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>æ¡œå¡š28æœŸï¼šåç°¿ãƒã‚¹ã‚¿ãƒ¼ç®¡ç†</title>
    <style>
        body { font-family: 'Zen Maru Gothic', sans-serif; margin: 0; background-color: #ffeef5; color: #555; padding: 10px; font-size: 13px; }
        .header { 
            background: rgba(255, 255, 255, 0.95); padding: 10px 15px; border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(233, 30, 99, 0.1); position: sticky; top: 0; z-index: 100;
            border: 1px solid #ffc0cb; display: flex; align-items: center; gap: 10px;
        }
        h2 { margin: 0; font-size: 15px; color: #d81b60; white-space: nowrap; }
        .status { font-size: 10px; padding: 2px 8px; border-radius: 10px; font-weight: bold; border: 1px solid #2ecc71; color: #2ecc71; background: #fff; }
        .syncing { border-color: #f1c40f; color: #f1c40f; }

        .controls { display: flex; gap: 5px; align-items: center; margin-left: auto; }
        .search-input { padding: 5px 10px; border: 1px solid #ffc0cb; border-radius: 15px; font-size: 12px; width: 130px; }
        .filter-select { padding: 4px; border: 1px solid #ffc0cb; border-radius: 10px; font-size: 11px; }
        .btn-add { background: #d81b60; color: white; border: none; padding: 5px 12px; border-radius: 15px; cursor: pointer; font-size: 11px; font-weight: bold; }

        table { width: 100%; border-collapse: collapse; background: #fff; margin-top: 8px; table-layout: fixed; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        th { background: #a51d4d; color: white; padding: 6px 2px; font-size: 11px; cursor: pointer; position: sticky; top: 65px; border: 1px solid #8e153e; }
        th:hover { background: #c2185b; }
        td { padding: 4px; border: 1px solid #ffeef5; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-align: center; }
        
        /* æ¨ªå¹…ã®æœ€é©åŒ– */
        .w-no { width: 25px; color: #bbb; font-size: 10px; }
        .w-name { width: 80px; font-weight: bold; text-align: left; padding-left: 8px; }
        .w-kana { width: 90px; color: #888; text-align: left; }
        .w-gen { width: 30px; }
        .w-cls { width: 35px; font-weight: bold; color: #d81b60; }
        .w-act { width: 35px; }

        .editable { background: #fffafc; cursor: text; }
        .editable:focus { background: #fff; outline: 1px solid #ff8da1; }
        .gender-tag { padding: 1px 4px; border-radius: 6px; font-size: 10px; font-weight: bold; cursor: pointer; }
        .gender-ç”· { background: #e3f2fd; color: #1e88e5; }
        .gender-å¥³ { background: #fce4ec; color: #d81b60; }
        .del-link { color: #ccc; font-size: 10px; cursor: pointer; }
        .del-link:hover { color: #ea4335; }
    </style>
</head>
<body>

<div class="header">
    <h2>ğŸŒ¸ 28æœŸåç°¿ç®¡ç†</h2>
    <div id="status" class="status">åŒæœŸæ¸ˆã¿</div>
    <div class="controls">
        <input type="text" id="q" class="search-input" placeholder="æ°åãƒ»ã‚«ãƒŠæ¤œç´¢...">
        <select id="fGen" class="filter-select"><option value="">æ€§åˆ¥</option><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option></select>
        <select id="fC1" class="filter-select"><option value="">1å¹´</option></select>
        <button class="btn-add" onclick="addM()">ï¼‹è¿½åŠ </button>
        <span style="font-size:11px; font-weight:bold; min-width:30px;">[<span id="cnt">0</span>]</span>
    </div>
</div>

<table id="tbl">
    <thead>
        <tr>
            <th class="w-no">No</th>
            <th class="w-name" onclick="srt('name')">æ°åâ–¼</th>
            <th class="w-kana" onclick="srt('kana')">ã‚«ãƒŠâ–¼</th>
            <th class="w-gen" onclick="srt('gen')">æ€§â–¼</th>
            <th class="w-cls" onclick="srt('c1')">1å¹´â–¼</th>
            <th class="w-cls" onclick="srt('c2')">2å¹´â–¼</th>
            <th class="w-cls" onclick="srt('c3')">3å¹´â–¼</th>
            <th class="w-act">æ¶ˆ</th>
        </tr>
    </thead>
    <tbody id="out"></tbody>
</table>

<script>
    const CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTzLqpB8e6tiN06L-urFd1agctJ6JIlfJQW-JcybZ_VrVYOh7D9uwk6PlIlO8wCpcQKVyUKRJOnchn-/pub?gid=0&single=true&output=csv";
    const GAS = "https://script.google.com/macros/s/AKfycbz0D_iO4VT3YTQH-THnVjOrZC0G4NajnXMLpQOMa3QYDZ53ZbvdQQK-23NP9KbNAtgsAg/exec"; // â˜…å¿…ãšGASã®URLã‚’è²¼ã£ã¦ãã ã•ã„

    let data = [];
    let sK = 'kana';
    let sA = true;

    function getG(v) {
        if(!v) return "";
        let m = String(v).match(/(\d+)[-æœˆ](\d+)/);
        return m ? m[2] : (String(v).match(/\d+/) ? String(v).match(/\d+/)[0] : v);
    }

    async function load() {
        const res = await fetch(CSV);
        const txt = await res.text();
        const rows = txt.replace(/\r/g, '').split('\n').slice(1);
        data = rows.map(r => {
            const c = r.split(',');
            return { name: c[0]||"", kana: c[1]||"", c1: getG(c[2]), c2: getG(c[4]), c3: getG(c[6]), gen: (c[8]||"ç”·").trim() };
        }).filter(m => m.name);
        
        // ã‚¯ãƒ©ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®å‹•çš„ç”Ÿæˆ
        const c1s = [...new Set(data.map(m => m.c1))].sort((a,b)=>a-b);
        c1s.forEach(c => { if(c) document.getElementById('fC1').innerHTML += `<option value="${c}">${c}çµ„</option>`; });
        
        render();
    }

    function render() {
        const body = document.getElementById('out');
        const q = document.getElementById('q').value.toLowerCase();
        const fg = document.getElementById('fGen').value;
        const fc = document.getElementById('fC1').value;
        body.innerHTML = "";

        const filtered = data.filter(m => 
            (m.name.includes(q) || m.kana.includes(q)) && (!fg || m.gen === fg) && (!fc || m.c1 === fc)
        );

        filtered.forEach((m, i) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="w-no">${i+1}</td>
                <td class="w-name">${m.name}</td>
                <td class="w-kana editable" contenteditable="true" onblur="sync('${m.name}','ãƒ•ãƒªã‚¬ãƒŠ',this.innerText)">${m.kana}</td>
                <td class="w-gen"><span class="gender-tag gender-${m.gen}" onclick="tglG(this,'${m.name}')">${m.gen}</span></td>
                <td class="w-cls editable" contenteditable="true" onblur="sync('${m.name}','1å¹´çµ„',this.innerText)">${m.c1}</td>
                <td class="w-cls editable" contenteditable="true" onblur="sync('${m.name}','2å¹´çµ„',this.innerText)">${m.c2}</td>
                <td class="w-cls editable" contenteditable="true" onblur="sync('${m.name}','3å¹´çµ„',this.innerText)">${m.c3}</td>
                <td class="w-act"><span class="del-link" onclick="delM('${m.name}')">Ã—</span></td>
            `;
            body.appendChild(tr);
        });
        document.getElementById('cnt').innerText = filtered.length;
    }

    async function sync(name, col, val) {
        const st = document.getElementById('status');
        st.innerText = "åŒæœŸä¸­..."; st.classList.add('syncing');
        let sv = val;
        if(col.includes('çµ„') && val && !val.includes('-')) sv = col.charAt(0) + "-" + val;
        try {
            await fetch(GAS, { method: "POST", body: JSON.stringify({ name: name, column: col, value: sv }) });
            st.innerText = "åŒæœŸæ¸ˆã¿"; st.classList.remove('syncing');
        } catch (e) { st.innerText = "ã‚¨ãƒ©ãƒ¼"; }
    }

    function tglG(el, name) {
        const nxt = el.innerText === 'ç”·' ? 'å¥³' : 'ç”·';
        el.innerText = nxt; el.className = `gender-tag gender-${nxt}`;
        sync(name, 'æ€§åˆ¥', nxt);
    }

    function addM() {
        const n = prompt("åå‰ã‚’å…¥åŠ›");
        if(n) { data.unshift({name:n, kana:"", c1:"", c2:"", c3:"", gen:"ç”·"}); render(); sync(n, "åå‰", n); }
    }

    async function delM(name) {
        if(confirm(name + "ã‚’å‰Šé™¤ï¼Ÿ")) {
            await fetch(GAS, { method: "POST", body: JSON.stringify({ action: "delete", name: name }) });
            data = data.filter(m => m.name !== name); render();
        }
    }

    function srt(k) {
        sA = (sK === k) ? !sA : true; sK = k;
        data.sort((a, b) => (a[k] < b[k] ? -1 : 1) * (sA ? 1 : -1));
        render();
    }

    document.getElementById('q').oninput = render;
    document.getElementById('fGen').onchange = render;
    document.getElementById('fC1').onchange = render;
    load();
</script>
</body>
</html>
