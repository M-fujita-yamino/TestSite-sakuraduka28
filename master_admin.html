<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>åç°¿ç®¡ç†ï¼šé€æ¬¡æ›´æ–°ã‚¨ãƒ‡ã‚£ã‚¿</title>
    <style>
        body { font-family: sans-serif; margin: 0; background: #f0f2f5; padding: 20px; }
        .header { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        .status-bar { font-size: 12px; padding: 5px 15px; border-radius: 4px; display: inline-block; margin-left: 10px; }
        .sync-ok { background: #e6ffed; color: #22863a; }
        .sync-loading { background: #fff8c5; color: #735c0f; }
        .btn { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: bold; }
        .btn-add { background: #4285f4; }
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 20px; }
        th { background: #f8f9fa; padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; cursor: pointer; font-size: 12px; position: sticky; top: 110px; }
        th:hover { background: #eee; }
        td { padding: 10px; border-bottom: 1px solid #eee; font-size: 13px; }
        .editable { background: #fffde7; cursor: text; }
        .editable:focus { background: #fff; outline: 2px solid #4285f4; }
        .gender-tag { padding: 2px 8px; border-radius: 10px; font-weight: bold; cursor: pointer; }
        .gender-ç”· { background: #e3f2fd; color: #1e88e5; }
        .gender-å¥³ { background: #fce4ec; color: #d81b60; }
    </style>
</head>
<body>

<div class="header">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 style="margin:0; color:#1a73e8;">ğŸ“ åŒæœŸä¼šåç°¿ãƒã‚¹ã‚¿ãƒ¼ç®¡ç†</h2>
        <div id="status" class="status-bar sync-ok">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¨åŒæœŸæ¸ˆã¿</div>
    </div>
    <div style="margin-top:15px; display:flex; gap:10px;">
        <button class="btn btn-add" onclick="addMember()">ï¼‹ æ–°è¦ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ </button>
        <input type="text" id="searchInput" placeholder="åå‰ãƒ»ãƒ•ãƒªã‚¬ãƒŠã§æ¤œç´¢..." style="padding:10px; width:250px; border:1px solid #ddd; border-radius:4px;">
    </div>
</div>

<table id="mainTable">
    <thead>
        <tr>
            <th onclick="sortData('name')">æ°å â–²â–¼</th>
            <th onclick="sortData('kana')">ãƒ•ãƒªã‚¬ãƒŠ â–²â–¼</th>
            <th onclick="sortData('gender')">æ€§åˆ¥ â–²â–¼</th>
            <th onclick="sortData('c1')">1å¹´çµ„ â–²â–¼</th>
            <th onclick="sortData('c2')">2å¹´çµ„ â–²â–¼</th>
            <th>æ“ä½œ</th>
        </tr>
    </thead>
    <tbody id="tableBody"></tbody>
</table>

<script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTzLqpB8e6tiN06L-urFd1agctJ6JIlfJQW-JcybZ_VrVYOh7D9uwk6PlIlO8wCpcQKVyUKRJOnchn-/pub?gid=0&single=true&output=csv";
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwuLHUojj-LibhzLrRap-JO9AES2xnQ8ufQAUtzVyFkwCeRYa-Z7uveX_BwOEV-fVFYig/exec";

    let memberData = [];
    let sortKey = 'kana';
    let sortAsc = true;

    async function load() {
        const res = await fetch(CSV_URL);
        const txt = await res.text();
        const rows = txt.split(/\r?\n/).slice(1);
        memberData = rows.map(r => {
            const c = r.split(',');
            return { name: c[0]||"", kana: c[1]||"", c1: c[2]||"", l1: c[3]||"", c2: c[4]||"", l2: c[5]||"", gen: c[8]||"ç”·" };
        }).filter(m => m.name);
        render();
    }

    function render() {
        const body = document.getElementById('tableBody');
        const q = document.getElementById('searchInput').value.toLowerCase();
        body.innerHTML = "";

        const filtered = memberData.filter(m => m.name.includes(q) || m.kana.includes(q));

        filtered.forEach((m, i) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${m.name}</td>
                <td class="editable" contenteditable="true" onblur="sync('${m.name}','ãƒ•ãƒªã‚¬ãƒŠ',this.innerText)">${m.kana}</td>
                <td><span class="gender-tag gender-${m.gen}" onclick="toggleG(this,'${m.name}')">${m.gen}</span></td>
                <td class="editable" contenteditable="true" onblur="sync('${m.name}','1å¹´çµ„',this.innerText)">${m.c1}</td>
                <td class="editable" contenteditable="true" onblur="sync('${m.name}','2å¹´çµ„',this.innerText)">${m.c2}</td>
                <td><button onclick="deleteMember('${m.name}')" style="color:red; background:none; border:none; cursor:pointer;">å‰Šé™¤</button></td>
            `;
            body.appendChild(tr);
        });
    }

    async function sync(name, col, val) {
        const st = document.getElementById('status');
        st.innerText = "åŒæœŸä¸­...";
        st.className = "status-bar sync-loading";
        try {
            await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ name: name, column: col, value: val }) });
            st.innerText = "åŒæœŸå®Œäº†ï¼ˆæœ€æ–°ï¼‰";
            st.className = "status-bar sync-ok";
        } catch (e) { st.innerText = "åŒæœŸã‚¨ãƒ©ãƒ¼"; }
    }

    function toggleG(el, name) {
        const next = el.innerText === 'ç”·' ? 'å¥³' : 'ç”·';
        el.innerText = next;
        el.className = `gender-tag gender-${next}`;
        sync(name, 'æ€§åˆ¥', next);
    }

    function addMember() {
        const n = prompt("åå‰ã‚’å…¥åŠ›");
        if(n) { memberData.unshift({name:n, kana:"", c1:"", l1:"", c2:"", l2:"", gen:"ç”·"}); render(); sync(n, "åå‰", n); }
    }

    async function deleteMember(name) {
        if(confirm(name + "ã•ã‚“ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "delete", name: name }) });
            memberData = memberData.filter(m => m.name !== name);
            render();
        }
    }

    function sortData(key) {
        sortAsc = (sortKey === key) ? !sortAsc : true;
        sortKey = key;
        memberData.sort((a, b) => (a[key] < b[key] ? -1 : 1) * (sortAsc ? 1 : -1));
        render();
    }

    document.getElementById('searchInput').oninput = render;
    load();
</script>
</body>
</html>
