// --- 修正版 sync 関数 ---
async function sync(oldKey, col, newVal) {
    const st = document.getElementById('status');
    st.innerText = "同期中..."; 
    st.style.borderColor = "#f1c40f"; 
    st.style.color = "#f1c40f";
    
    // 空白除去と整形
    let nameKey = String(oldKey).trim();
    let val = String(newVal).trim();
    
    // クラス保存用の整形（例：2組 -> 1-2）
    if(col.includes('組') && val && !val.includes('-')) {
        val = col.charAt(0) + "-" + val;
    }

    try {
        const response = await fetch(GAS, { 
            method: "POST", 
            body: JSON.stringify({ name: nameKey, column: col, value: val }) 
        });
        
        if (!response.ok) throw new Error('Network response was not ok');

        st.innerText = "同期済み"; 
        st.style.borderColor = "#2ecc71"; 
        st.style.color = "#2ecc71";
        
        // メモリ上のデータも更新して整合性を保つ
        const target = data.find(m => m.originalName === oldKey);
        if(target) {
            if(col === '名前') target.originalName = val;
            // 内部プロパティ名のマッピング
            const propMap = {"名前":"name", "フリガナ":"kana", "1年組":"c1", "2年組":"c2", "3年組":"c3", "性別":"gen"};
            if(propMap[col]) target[propMap[col]] = val;
        }
    } catch (e) { 
        st.innerText = "同期失敗"; 
        st.style.borderColor = "#ea4335";
        st.style.color = "#ea4335";
        console.error("Error:", e);
    }
}

// --- 修正版 性別トグル関数 ---
function tglG(el, name) {
    const current = el.innerText.trim();
    const next = current === '男' ? '女' : '男';
    
    // 見た目を先に変える
    el.innerText = next; 
    el.className = `gender-tag gender-${next}`;
    
    // GASに送信
    sync(name, '性別', next);
}
