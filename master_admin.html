<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>æ¡œå¡š28æœŸï¼šåç°¿ç®¡ç†ã‚¨ãƒ‡ã‚£ã‚¿</title>
    <style>
        body { font-family: 'Zen Maru Gothic', sans-serif; margin: 0; background-color: #ffeef5; color: #555; padding: 10px; }
        .header { 
            background: rgba(255, 255, 255, 0.9); padding: 12px 20px; border-radius: 15px; 
            box-shadow: 0 4px 15px rgba(233, 30, 99, 0.1); position: sticky; top: 0; z-index: 100;
            border: 1px solid #ffc0cb; display: flex; align-items: center; gap: 15px;
        }
        h2 { margin: 0; font-size: 16px; color: #d81b60; white-space: nowrap; }
        
        .status-badge { font-size: 10px; padding: 2px 8px; border-radius: 10px; font-weight: bold; }
        .sync-ok { background: #fff; color: #2ecc71; border: 1px solid #2ecc71; }
        .sync-loading { background: #fff; color: #f1c40f; border: 1px solid #f1c40f; }

        .controls { display: flex; gap: 10px; align-items: center; margin-left: auto; }
        input[type="text"] { 
            padding: 6px 12px; border: 1px solid #ffc0cb; border-radius: 20px; 
            font-size: 13px; outline: none; background: #fff; width: 150px;
        }
        .btn-add { 
            background: #d81b60; color: white; border: none; padding: 6px 15px; 
            border-radius: 20px; cursor: pointer; font-size: 12px; font-weight: bold; 
        }

        table { width: 100%; border-collapse: collapse; background: #fff; margin-top: 10px; border-radius: 10px; overflow: hidden; table-layout: fixed; }
        th { background: #a51d4d; color: white; padding: 8px 4px; font-size: 11px; text-align: left; position: sticky; top: 75px; border: 1px solid #8e153e; }
        td { padding: 4px 6px; border-bottom: 1px solid #ffeef5; font-size: 13px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        /* ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å¹…ã‚’æ¥µé™ã¾ã§è©°ã‚ã‚‹ */
        .w-no { width: 25px; text-align: center; color: #bbb; font-size: 10px; }
        .w-name { width: 85px; font-weight: bold; }
        .w-kana { width: 100px; color: #888; }
        .w-gen { width: 35px; text-align: center; }
        .w-cls { width: 40px; text-align: center; font-weight: bold; color: #d81b60; }
        .w-act { width: 40px; text-align: center; }

        .editable { background: #fffafc; cursor: text; border-radius: 4px; }
        .editable:focus { background: #fff; outline: 1px solid #ff8da1; box-shadow: inset 0 0 5px rgba(255,141,161,0.2); }
        
        .gender-tag { padding: 2px 4px; border-radius: 6px; font-size: 10px; font-weight: bold; cursor: pointer; }
        .gender-ç”· { background: #e3f2fd; color: #1e88e5; }
        .gender-å¥³ { background: #fce4ec; color: #d81b60; }
        
        .del-link { color: #ccc; font-size: 10px; cursor: pointer; text-decoration: none; }
        .del-link:hover { color: #ea4335; }
    </style>
</head>
<body>

<div class="header">
    <h2>ğŸŒ¸ 28æœŸåç°¿ãƒ¡ãƒ³ãƒ†</h2>
    <div id="status" class="status-badge sync-ok">åŒæœŸæ¸ˆã¿</div>
    <div class="controls">
        <input type="text" id="searchInput" placeholder="æ¤œç´¢...">
        <button class="btn-add" onclick="addMember()">ï¼‹ è¿½åŠ </button>
        <div style="font-size:11px; font-weight:bold;">è¨ˆ <span id="count">0</span> å</div>
    </div>
</div>

<table id="mainTable">
    <thead>
        <tr>
            <th class="w-no">No</th>
            <th class="w-name">æ°å</th>
            <th class="w-kana">ãƒ•ãƒªã‚¬ãƒŠ</th>
            <th class="w-gen">æ€§</th>
            <th class="w-cls">1å¹´</th>
            <th class="w-cls">2å¹´</th>
            <th class="w-cls">3å¹´</th>
            <th class="w-act">æ“ä½œ</th>
        </tr>
    </thead>
    <tbody id="tableBody"></tbody>
</table>

<script>
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTzLqpB8e6tiN06L-urFd1agctJ6JIlfJQW-JcybZ_VrVYOh7D9uwk6PlIlO8wCpcQKVyUKRJOnchn-/pub?gid=0&single=true&output=csv";
    
    // ğŸŒ¸ ä»¥å‰å–å¾—ã—ãŸGASã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURLã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzVaByOSHIiCD7b0B4PiKL1003bc2jqJ34kJvVYgl1s4icuqUGw-VaUgfAQcJomExPddA/exec";

    let memberData = [];

    // ã‚¯ãƒ©ã‚¹åã‹ã‚‰æ•°å­—ã ã‘ã‚’æŠ½å‡ºã™ã‚‹é–¢æ•° (1-2 ã‚„ 1æœˆ2æ—¥ ã‚’ 2 ã«å¤‰æ›)
    function extractGroup(val) {
        if (!val) return "";
        let str = String(val).trim();
        let match = str.match(/(\d+)[-æœˆ](\d+)/); // 1-2 ã‚„ 1æœˆ2æ—¥
        if (match) return match[2]; 
        let singleMatch = str.match(/\d+/); // å˜ãªã‚‹æ•°å­—
        return singleMatch ? singleMatch[0] : str;
    }

    async function load() {
        try {
            const res = await fetch(SHEET_URL);
            const txt = await res.text();
            const rows = txt.replace(/\r/g, '').split('\n').slice(1);
            memberData = rows.map(r => {
                const c = r.split(',');
                return { 
                    name: (c[0]||"").trim(), 
                    kana: (c[1]||"").trim(), 
                    c1: extractGroup(c[2]), 
                    c2: extractGroup(c[4]), 
                    c3: extractGroup(c[6]), 
                    gen: (c[8]||"ç”·").trim() 
                };
            }).filter(m => m.name);
            render();
        } catch (e) { console.error(e); }
    }

    function render() {
        const body = document.getElementById('tableBody');
        const q = document.getElementById('searchInput').value.toLowerCase();
        body.innerHTML = "";

        const filtered = memberData.filter(m => m.name.includes(q) || m.kana.includes(q));

        filtered.forEach((m, i) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="w-no">${i+1}</td>
                <td class="w-name">${m.name}</td>
                <td class="w-kana editable" contenteditable="true" onblur="sync('${m.name}','ãƒ•ãƒªã‚¬ãƒŠ',this.innerText)">${m.kana}</td>
                <td class="w-gen"><span class="gender-tag gender-${m.gen}" onclick="toggleG(this,'${m.name}')">${m.gen}</span></td>
                <td class="w-cls editable" contenteditable="true" onblur="sync('${m.name}','1å¹´çµ„',this.innerText)">${m.c1}</td>
                <td class="w-cls editable" contenteditable="true" onblur="sync('${m.name}','2å¹´çµ„',this.innerText)">${m.c2}</td>
                <td class="w-cls editable" contenteditable="true" onblur="sync('${m.name}','3å¹´çµ„',this.innerText)">${m.c3}</td>
                <td class="w-act"><span class="del-link" onclick="deleteMember('${m.name}')">å‰Šé™¤</span></td>
            `;
            body.appendChild(tr);
        });
        document.getElementById('count').innerText = filtered.length;
    }

    async function sync(name, col, val) {
        const st = document.getElementById('status');
        st.innerText = "åŒæœŸä¸­...";
        st.className = "status-badge sync-loading";
        
        // ã‚·ãƒ¼ãƒˆå´ã«ã¯ã€Œ1-nã€ã®å½¢å¼ã§ä¿å­˜ã™ã‚‹ãŸã‚ã«æ•´å½¢
        let saveValue = val;
        if(col.includes('çµ„') && val && !val.includes('-')) {
            let year = col.charAt(0); // "1å¹´çµ„" -> "1"
            saveValue = year + "-" + val;
        }

        try {
            await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ name: name, column: col, value: saveValue }) });
            st.innerText = "åŒæœŸæ¸ˆã¿";
            st.className = "status-badge sync-ok";
        } catch (e) { st.innerText = "ã‚¨ãƒ©ãƒ¼"; }
    }

    function toggleG(el, name) {
        const next = el.innerText === 'ç”·' ? 'å¥³' : 'ç”·';
        el.innerText = next;
        el.className = `gender-tag gender-${next}`;
        sync(name, 'æ€§åˆ¥', next);
    }

    function addMember() {
        const n = prompt("åå‰ã‚’å…¥åŠ›");
        if(n) { 
            memberData.unshift({name:n, kana:"", c1:"", c2:"", c3:"", gen:"ç”·"}); 
            render(); 
            sync(n, "åå‰", n); 
        }
    }

    async function deleteMember(name) {
        if(confirm(name + "ã•ã‚“ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "delete", name: name }) });
            memberData = memberData.filter(m => m.name !== name);
            render();
        }
    }

    document.getElementById('searchInput').oninput = render;
    load();
</script>
</body>
</html>
